# .github/workflows/reusable-connection-check.yml
# 목적: 배포된 서버의 주소와 포트로 네트워크 연결을 시도합니다.
name: Reusable - Connection Check

on:
  workflow_call:
    # 입력값 대신 비밀값으로 받음 (호출자가 secrets 블록으로 전달)
    secrets:
      server_address:
        description: 'Address (ALB DNS or IP) of the deployed server'
        required: true
      server_port:
        description: 'Port number of the deployed server'
        required: true

jobs:
  check_job:
    name: Check Connection to Server
    runs-on: ubuntu-latest
    steps:
      # 1. netcat 설치
      - name: Install netcat
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends netcat-openbsd && sudo rm -rf /var/lib/apt/lists/*

      # 2. 연결 시도 (재시도 로직 포함)
      - name: Attempt connection using netcat
        env:
          # 비밀값을 환경 변수로 사용
          SERVER_ADDRESS: ${{ secrets.server_address }}
          SERVER_PORT: ${{ secrets.server_port }}
        run: |
          set -e # 루프 내 성공 시 exit 0 하므로, 루프 후 실패 시 exit 1 되도록 함
          echo "Attempting to connect to $SERVER_ADDRESS on port $SERVER_PORT..."
          for i in {1..5}; do
            # nc -zvw 5 : 5초 타임아웃, 상세 출력, 스캔 모드
            if nc -z -v -w 5 $SERVER_ADDRESS $SERVER_PORT; then
              echo "Connection successful!"
              exit 0 # 성공!
            fi
            if [ $i -lt 5 ]; then
              echo "Connection attempt $i failed. Retrying in 10 seconds..."
              sleep 10
            fi
          done
          echo "Connection failed after multiple attempts!"
          exit 1 # 최종 실패